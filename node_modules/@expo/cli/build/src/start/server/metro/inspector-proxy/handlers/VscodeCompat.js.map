{"version":3,"sources":["../../../../../../../src/start/server/metro/inspector-proxy/handlers/VscodeCompat.ts"],"sourcesContent":["import type { Protocol } from 'devtools-protocol';\nimport type { DebuggerInfo } from 'metro-inspector-proxy';\n\nimport { CdpMessage, DebuggerRequest, DeviceResponse, InspectorHandler } from './types';\n\nexport class VscodeCompatHandler implements InspectorHandler {\n  /** Keep track of `Runtime.getProperties` responses to intercept, by request id */\n  interceptGetProperties = new Set<number>();\n\n  onDebuggerMessage(\n    message:\n      | DebuggerRequest<DebuggerGetPossibleBreakpoints>\n      | DebuggerRequest<DebuggerSetBreakpointByUrl>\n      | DebuggerRequest<RuntimeGetProperties>,\n    { socket }: Pick<DebuggerInfo, 'socket'>\n  ) {\n    // Hermes doesn't seem to handle this request, but `locations` have to be returned.\n    // Respond with an empty location to make it \"spec compliant\" with Chrome DevTools.\n    if (message.method === 'Debugger.getPossibleBreakpoints') {\n      const response: DeviceResponse<DebuggerGetPossibleBreakpoints> = {\n        id: message.id,\n        result: { locations: [] },\n      };\n      socket.send(JSON.stringify(response));\n      return true;\n    }\n\n    // Vscode doesn't seem to work nicely with missing `description` fields on `RemoteObject` instances.\n    // See: https://github.com/microsoft/vscode-js-debug/issues/1583\n    if (message.method === 'Runtime.getProperties') {\n      this.interceptGetProperties.add(message.id);\n    }\n\n    // Hermes and vscode have trouble setting breakpoints by `urlRegex` through `Debugger.setBreakpointByUrl`.\n    // Vscode adds `file://` to a URL containing `http://`, which confuses Hermes and sets it to the wrong location.\n    // Hermes needs to create the breakpoint to get the proper ID, but it must be unbounded.\n    // Once the sourcemap is loaded, vscode will rebind the unbounded breakpoint to the correct location (using `Debugger.setBreakpoint`).\n    if (message.method === 'Debugger.setBreakpointByUrl' && message.params.urlRegex) {\n      // Explicitly force the breakpoint to be unbounded\n      message.params.url = 'file://__invalid_url__';\n      delete message.params.urlRegex;\n    }\n\n    return false;\n  }\n\n  onDeviceMessage(message: DeviceResponse<RuntimeGetProperties>) {\n    // Vscode doesn't seem to work nicely with missing `description` fields on `RemoteObject` instances.\n    // See: https://github.com/microsoft/vscode-js-debug/issues/1583\n    if ('id' in message && this.interceptGetProperties.has(message.id)) {\n      this.interceptGetProperties.delete(message.id);\n\n      for (const item of message.result.result ?? []) {\n        // Force-fully format the properties description to be an empty string\n        // See: https://github.com/facebook/hermes/issues/114\n        if (item.value) {\n          item.value.description = item.value.description ?? '';\n        }\n\n        // Avoid passing the `objectId` for symbol types.\n        // When collapsing in vscode, it will fetch information about the symbol using the `objectId`.\n        // The `Runtime.getProperties` request of the symbol hard-crashes Hermes.\n        if (item.value?.type === 'symbol' && item.value.objectId) {\n          delete item.value.objectId;\n        }\n      }\n    }\n\n    return false;\n  }\n}\n\n/** @see https://chromedevtools.github.io/devtools-protocol/v8/Debugger/#method-getPossibleBreakpoints */\nexport type DebuggerGetPossibleBreakpoints = CdpMessage<\n  'Debugger.getPossibleBreakpoints',\n  Protocol.Debugger.GetPossibleBreakpointsRequest,\n  Protocol.Debugger.GetPossibleBreakpointsResponse\n>;\n\n/** @see https://chromedevtools.github.io/devtools-protocol/v8/Debugger/#method-setBreakpointByUrl */\nexport type DebuggerSetBreakpointByUrl = CdpMessage<\n  'Debugger.setBreakpointByUrl',\n  Protocol.Debugger.SetBreakpointByUrlRequest,\n  Protocol.Debugger.SetBreakpointByUrlResponse\n>;\n\n/** @see https://chromedevtools.github.io/devtools-protocol/v8/Runtime/#method-getProperties */\nexport type RuntimeGetProperties = CdpMessage<\n  'Runtime.getProperties',\n  Protocol.Runtime.GetPropertiesRequest,\n  Protocol.Runtime.GetPropertiesResponse\n>;\n"],"names":["VscodeCompatHandler","interceptGetProperties","Set","onDebuggerMessage","message","socket","method","response","id","result","locations","send","JSON","stringify","add","params","urlRegex","url","onDeviceMessage","has","delete","item","value","description","type","objectId"],"mappings":"AAAA;;;;AAKO,MAAMA,mBAAmB;IAC9B,kFAAkF,CAClFC,sBAAsB,GAAG,IAAIC,GAAG,EAAU,CAAC;IAE3CC,iBAAiB,CACfC,OAGyC,EACzC,EAAEC,MAAM,CAAA,EAAgC,EACxC;QACA,mFAAmF;QACnF,mFAAmF;QACnF,IAAID,OAAO,CAACE,MAAM,KAAK,iCAAiC,EAAE;YACxD,MAAMC,QAAQ,GAAmD;gBAC/DC,EAAE,EAAEJ,OAAO,CAACI,EAAE;gBACdC,MAAM,EAAE;oBAAEC,SAAS,EAAE,EAAE;iBAAE;aAC1B,AAAC;YACFL,MAAM,CAACM,IAAI,CAACC,IAAI,CAACC,SAAS,CAACN,QAAQ,CAAC,CAAC,CAAC;YACtC,OAAO,IAAI,CAAC;SACb;QAED,oGAAoG;QACpG,gEAAgE;QAChE,IAAIH,OAAO,CAACE,MAAM,KAAK,uBAAuB,EAAE;YAC9C,IAAI,CAACL,sBAAsB,CAACa,GAAG,CAACV,OAAO,CAACI,EAAE,CAAC,CAAC;SAC7C;QAED,0GAA0G;QAC1G,gHAAgH;QAChH,wFAAwF;QACxF,sIAAsI;QACtI,IAAIJ,OAAO,CAACE,MAAM,KAAK,6BAA6B,IAAIF,OAAO,CAACW,MAAM,CAACC,QAAQ,EAAE;YAC/E,kDAAkD;YAClDZ,OAAO,CAACW,MAAM,CAACE,GAAG,GAAG,wBAAwB,CAAC;YAC9C,OAAOb,OAAO,CAACW,MAAM,CAACC,QAAQ,CAAC;SAChC;QAED,OAAO,KAAK,CAAC;KACd;IAEDE,eAAe,CAACd,OAA6C,EAAE;QAC7D,oGAAoG;QACpG,gEAAgE;QAChE,IAAI,IAAI,IAAIA,OAAO,IAAI,IAAI,CAACH,sBAAsB,CAACkB,GAAG,CAACf,OAAO,CAACI,EAAE,CAAC,EAAE;YAClE,IAAI,CAACP,sBAAsB,CAACmB,MAAM,CAAChB,OAAO,CAACI,EAAE,CAAC,CAAC;gBAE5BJ,OAAqB;YAAxC,KAAK,MAAMiB,IAAI,IAAIjB,CAAAA,OAAqB,GAArBA,OAAO,CAACK,MAAM,CAACA,MAAM,YAArBL,OAAqB,GAAI,EAAE,CAAE;oBAU1CiB,GAAU;gBATd,sEAAsE;gBACtE,qDAAqD;gBACrD,IAAIA,IAAI,CAACC,KAAK,EAAE;wBACWD,YAAsB;oBAA/CA,IAAI,CAACC,KAAK,CAACC,WAAW,GAAGF,CAAAA,YAAsB,GAAtBA,IAAI,CAACC,KAAK,CAACC,WAAW,YAAtBF,YAAsB,GAAI,EAAE,CAAC;iBACvD;gBAED,iDAAiD;gBACjD,8FAA8F;gBAC9F,yEAAyE;gBACzE,IAAIA,CAAAA,CAAAA,GAAU,GAAVA,IAAI,CAACC,KAAK,SAAM,GAAhBD,KAAAA,CAAgB,GAAhBA,GAAU,CAAEG,IAAI,CAAA,KAAK,QAAQ,IAAIH,IAAI,CAACC,KAAK,CAACG,QAAQ,EAAE;oBACxD,OAAOJ,IAAI,CAACC,KAAK,CAACG,QAAQ,CAAC;iBAC5B;aACF;SACF;QAED,OAAO,KAAK,CAAC;KACd;CACF;QAjEYzB,mBAAmB,GAAnBA,mBAAmB"}