{"version":3,"sources":["../../../../../src/start/server/metro/instantiateMetro.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport { MetroDevServerOptions } from '@expo/dev-server';\nimport chalk from 'chalk';\nimport http from 'http';\nimport Metro from 'metro';\nimport { Terminal } from 'metro-core';\n\nimport { Log } from '../../../log';\nimport { getMetroProperties } from '../../../utils/analytics/getMetroProperties';\nimport { createDebuggerTelemetryMiddleware } from '../../../utils/analytics/metroDebuggerMiddleware';\nimport { logEventAsync } from '../../../utils/analytics/rudderstackClient';\nimport { env } from '../../../utils/env';\nimport { createDevServerMiddleware } from '../middleware/createDevServerMiddleware';\nimport { getPlatformBundlers } from '../platformBundlers';\nimport { MetroBundlerDevServer } from './MetroBundlerDevServer';\nimport { MetroTerminalReporter } from './MetroTerminalReporter';\nimport { createInspectorProxy } from './inspector-proxy';\nimport { importExpoMetroConfigFromProject, importMetroFromProject } from './resolveFromProject';\nimport { withMetroMultiPlatformAsync } from './withMetroMultiPlatform';\n\n// From expo/dev-server but with ability to use custom logger.\ntype MessageSocket = {\n  broadcast: (method: string, params?: Record<string, any> | undefined) => void;\n};\n\n/** The most generic possible setup for Metro bundler. */\nexport async function instantiateMetroAsync(\n  metroBundler: MetroBundlerDevServer,\n  options: Omit<MetroDevServerOptions, 'logger'>\n): Promise<{\n  server: http.Server;\n  middleware: any;\n  messageSocket: MessageSocket;\n}> {\n  const projectRoot = metroBundler.projectRoot;\n\n  let reportEvent: ((event: any) => void) | undefined;\n\n  const Metro = importMetroFromProject(projectRoot);\n  const ExpoMetroConfig = importExpoMetroConfigFromProject(projectRoot);\n\n  const terminal = new Terminal(process.stdout);\n  const terminalReporter = new MetroTerminalReporter(projectRoot, terminal);\n\n  const reporter = {\n    update(event: any) {\n      terminalReporter.update(event);\n      if (reportEvent) {\n        reportEvent(event);\n      }\n    },\n  };\n\n  let metroConfig = await ExpoMetroConfig.loadAsync(projectRoot, { reporter, ...options });\n\n  // TODO: When we bring expo/metro-config into the expo/expo repo, then we can upstream this.\n  const { exp } = getConfig(projectRoot, {\n    skipSDKVersionRequirement: true,\n    skipPlugins: true,\n  });\n\n  const platformBundlers = getPlatformBundlers(exp);\n  metroConfig = await withMetroMultiPlatformAsync(projectRoot, metroConfig, platformBundlers);\n\n  logEventAsync('metro config', getMetroProperties(projectRoot, exp, metroConfig));\n\n  const {\n    middleware,\n    attachToServer,\n\n    // New\n    websocketEndpoints,\n    eventsSocketEndpoint,\n    messageSocketEndpoint,\n  } = createDevServerMiddleware(projectRoot, {\n    port: metroConfig.server.port,\n    watchFolders: metroConfig.watchFolders,\n  });\n\n  const customEnhanceMiddleware = metroConfig.server.enhanceMiddleware;\n  // @ts-ignore can't mutate readonly config\n  metroConfig.server.enhanceMiddleware = (metroMiddleware: any, server: Metro.Server) => {\n    if (customEnhanceMiddleware) {\n      metroMiddleware = customEnhanceMiddleware(metroMiddleware, server);\n    }\n    return middleware.use(metroMiddleware);\n  };\n\n  // Create the custom inspector proxy only when enabled and opt-in\n  const inspectorProxy =\n    metroConfig.server.runInspectorProxy && env.EXPO_USE_CUSTOM_INSPECTOR_PROXY\n      ? createInspectorProxy(metroBundler, metroBundler.projectRoot)\n      : null;\n\n  if (inspectorProxy) {\n    // @ts-expect-error Property is read-only, but we need to disable it\n    metroConfig.server.runInspectorProxy = false;\n  }\n\n  middleware.use(createDebuggerTelemetryMiddleware(projectRoot, exp));\n\n  const server = await Metro.runServer(metroConfig, {\n    hmrEnabled: true,\n    websocketEndpoints: {\n      ...websocketEndpoints,\n      ...(inspectorProxy ? inspectorProxy.createWebSocketListeners() : {}),\n    },\n    // @ts-expect-error Property was added in 0.73.4, remove this statement when updating Metro\n    watch: isWatchEnabled(),\n  });\n\n  // Hook the inspector proxy in the Metro server\n  if (inspectorProxy) {\n    inspectorProxy.setServerAddress(server);\n    middleware.use(inspectorProxy.processRequest);\n  }\n\n  if (attachToServer) {\n    // Expo SDK 44 and lower\n    const { messageSocket, eventsSocket } = attachToServer(server);\n    reportEvent = eventsSocket.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket,\n    };\n  } else {\n    // RN +68 -- Expo SDK +45\n    reportEvent = eventsSocketEndpoint.reportEvent;\n\n    return {\n      server,\n      middleware,\n      messageSocket: messageSocketEndpoint,\n    };\n  }\n}\n\n/**\n * Simplify and communicate if Metro is running without watching file updates,.\n * Exposed for testing.\n */\nexport function isWatchEnabled() {\n  if (env.CI) {\n    Log.log(\n      chalk`Metro is running in CI mode, reloads are disabled. Remove {bold CI=true} to enable watch mode.`\n    );\n  }\n\n  return !env.CI;\n}\n"],"names":["instantiateMetroAsync","isWatchEnabled","metroBundler","options","projectRoot","reportEvent","Metro","importMetroFromProject","ExpoMetroConfig","importExpoMetroConfigFromProject","terminal","Terminal","process","stdout","terminalReporter","MetroTerminalReporter","reporter","update","event","metroConfig","loadAsync","exp","getConfig","skipSDKVersionRequirement","skipPlugins","platformBundlers","getPlatformBundlers","withMetroMultiPlatformAsync","logEventAsync","getMetroProperties","middleware","attachToServer","websocketEndpoints","eventsSocketEndpoint","messageSocketEndpoint","createDevServerMiddleware","port","server","watchFolders","customEnhanceMiddleware","enhanceMiddleware","metroMiddleware","use","inspectorProxy","runInspectorProxy","env","EXPO_USE_CUSTOM_INSPECTOR_PROXY","createInspectorProxy","createDebuggerTelemetryMiddleware","runServer","hmrEnabled","createWebSocketListeners","watch","setServerAddress","processRequest","messageSocket","eventsSocket","CI","Log","log","chalk"],"mappings":"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"}